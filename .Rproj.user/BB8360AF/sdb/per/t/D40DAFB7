{
    "collab_server" : "",
    "contents" : "## AUTHOR: Reginald Edwards\n## CREATED: 31 July 2018\n## DESCRIPTION: Query Compustat data from WRDS\n\nlibrary(dplyr)\nlibrary(RPostgres)\nsource('../0_datasets/wrds_login.R')\nwrds <- dbConnect(Postgres(), \n                  host='wrds-pgdata.wharton.upenn.edu',\n                  port=9737,\n                  user=wrds_user,\n                  password=wrds_pw,\n                  sslmode='require',\n                  dbname='wrds')\n\nres <- dbSendQuery(wrds, \n                   \"SELECT * from comp.funda where indfmt = 'INDL' \n                   and datafmt = 'STD'\n                   and popsrc = 'D'\n                   and consol = 'C'\n                   and final = 'Y'\")\ncomp.funda <- dbFetch(res)\ndbClearResult(res)\nsave(comp.funda, file = '0_datasets/comp_funda.RData')\n\n###############################################################################\n## Compute Annual Financial Ratios\n###############################################################################\n\nkeep.vars <- c(\"gvkey\", \"datadate\", \"fyear\", \"fyr\", \"tic\", \"prcc_f\", \"seq\", \n               \"ceq\", \"txditc\", \"txdb\", \"itcb\", \"pstkrv\", \"pstkl\", \"pstk\", \n               \"prcc_f\", \"csho\", \n               \"epsfx\", \"epsfi\", \"oprepsx\", \"opeps\", \"ajex\", \"ebit\", \"spi\", \n               \"nopi\", \"sale\", \n               \"ibadj\", \"dvc\", \"dvp\", \"ib\", \"oibdp\", \"dp\", \"oiadp\", \"gp\", \n               \"revt\", \"cogs\", \n               \"pi\", \"ibc\", \"dpc\", \"at\", \"ni\", \"ibcom\", \"icapt\", \"mib\", \n               \"ebitda\", \"xsga\",\n               \"xido\", \"xint\", \"mii\", \"ppent\", \"act\", \"lct\", \"dltt\", \"dlc\", \n               \"che\", \"invt\", \n               \"lt\", \"rect\", \"xopr\", \"oancf\", \"txp\", \"txt\", \"ap\", \"xrd\", \n               \"xad\", \"xlr\", \"capx\")\n\ncomp.funda <- comp.funda[keep.vars]\ncomp.funda <- comp.funda[order(comp.funda$gvkey, comp.funda$fyear), ]\n\n## Data filters\ncomp.funda <- comp.funda[comp.funda$at > 10, ]\ncomp.funda <- comp.funda[comp.funda$seq > 0, ]\ncomp.funda <- comp.funda[which(comp.funda$sale > 0), ]\ncomp.funda <- comp.funda[which(comp.funda$prcc_f > 2), ]\n\n## label first year/observation for each firm (gvkey)\nfirst.fyear <- aggregate(comp.funda$fyear, by  = list(comp.funda$gvkey), FUN = min)\nnames(first.fyear) <- c('gvkey', 'fyear')\nfirst.fyear$first <- 1\ncomp.funda <- merge(comp.funda, first.fyear, all.x = TRUE)\ncomp.funda$first <- ifelse(is.na(comp.funda$first), 0, comp.funda$first)\n\n# year gap between consecutive records\ncomp.funda$fyear.lag1 <- lag(comp.funda$fyear)\ncomp.funda$fyear.lag1 <- ifelse(comp.funda$first == 1, NA, comp.funda$fyear.lag1)\ncomp.funda$gap <- comp.funda$fyear - comp.funda$fyear.lag1\n\n## create market value variable\ncomp.funda$mktval <- comp.funda$prcc_f*comp.funda$csho\n\n# set assets (at) and revenue (sale) to missing if they are negative\ncomp.funda$at <- ifelse(comp.funda$at <=  0, NA, comp.funda$at)\ncomp.funda$sale <- ifelse(comp.funda$sale <=  0, NA, comp.funda$sale)\n\n# preferred stock\ncomp.funda$pstk_new <- dplyr::coalesce(comp.funda$pstkrv, comp.funda$pstkl, comp.funda$pstk)\n\n# Shareholder's Equity\nx <- coalesce(comp.funda$txditc, rowSums(comp.funda[, c(\"txdb\", \"itcb\")], na.rm = TRUE))\ncomp.funda$be = rowSums( data.frame(comp.funda$seq, x, -comp.funda$pstk_new), na.rm = TRUE);\ncomp.funda$be <- ifelse(comp.funda$be <= 0, NA, comp.funda$be)\n\n# book-to-market\ncomp.funda$bm <- comp.funda$be/(comp.funda$mktval)\ncomp.funda$bm <- ifelse(comp.funda$bm <= 0, NA, comp.funda$bm)\n\n# invested capital\ncomp.funda$icapt <- coalesce(comp.funda$icapt, rowSums(comp.funda[ , c(\"dltt\", \"pstk\", \"mib\", \"ceq\")], na.rm = TRUE))\n\n# operating cash-flow\ncomp.funda$ch_act <- c(NA, diff(comp.funda$act))\ncomp.funda$ch_che <- c(NA, diff(comp.funda$che))\ncomp.funda$ch_lct <- c(NA, diff(comp.funda$lct))\ncomp.funda$ch_dlc <- c(NA, diff(comp.funda$dlc))\ncomp.funda$ch_txp <- c(NA, diff(comp.funda$txp))\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"ch_act\"] <- NA\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"ch_che\"] <- NA\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"ch_lct\"] <- NA\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"ch_dlc\"] <- NA\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"ch_txp\"] <- NA\n\ncomp.funda$ocf <- coalesce(comp.funda$oancf, \n                           comp.funda$ib - (comp.funda$ch_act - comp.funda$ch_che - comp.funda$ch_lct + \n                                              comp.funda$ch_dlc + comp.funda$ch_txp), \n                           -comp.funda$dp)\n## remove lagged generated variable if it is the first year/observation\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"ocf\"] <- NA\n\n\n#### Annual Valuation Ratios\n# Enterprise Value Multiple:\n# (market value of common stock + market value of preferred equity + market\n# value of debt + minority interest - cash and investments) divided by EBITDA\ncomp.funda$evm <- rowSums(comp.funda[, c(\"dltt\", \"dlc\", \"mib\", \"pstk_new\", \n                                         \"mktval\")], na.rm = TRUE)/coalesce(comp.funda$ebitda, comp.funda$oibdp, comp.funda$sale -\n                                                                              comp.funda$cogs - comp.funda$xsga) \n\n# price-to-operating EPS, excl. EI (basic)\ncomp.funda$pe_op_basic <- comp.funda$prcc_f/(comp.funda$opeps/comp.funda$ajex)\n\n# price-to-operating EPS, excl. EI (diluted)\ncomp.funda$pe_op_dil <- comp.funda$prcc_f/(comp.funda$oprepsx/comp.funda$ajex)\n\n# price-to-earnings, excl. EI (diluted)\ncomp.funda$pe_exi <- comp.funda$prcc_f/(comp.funda$epsfx/comp.funda$ajex)\n\n# price-to-earnings, incl. EI (diluted)\ncomp.funda$pe_inc <- comp.funda$prcc_f/(comp.funda$epsfi/comp.funda$ajex)\n\n# price-to-sales ratio\ncomp.funda$ps <- comp.funda$prcc_f/comp.funda$sale\n\n# price-to-cash flow\ncomp.funda$pcf <-comp.funda$prcc_f/comp.funda$ocf\n\n# dividend payout ratio\ncomp.funda$dpr <- ifelse(comp.funda$ibadj > 0, comp.funda$dvc/comp.funda$ibadj, 0)\n\n###############################################################################\n## Profitability Ratios and Rates of Return\n\n# net profit margin\ncomp.funda$npm <- comp.funda$ib/comp.funda$sale\n\n# operating profit margin before depreciation\ncomp.funda$opmbd <- coalesce(comp.funda$oibdp, comp.funda$sale - \n                               comp.funda$xopr, comp.funda$revt - comp.funda$xopr)/comp.funda$sale  \n\n# operating profit margin after depreciation\ncomp.funda$opmad <- coalesce(comp.funda$oiadp, comp.funda$oibdp - comp.funda$dp, \n                             comp.funda$sale - comp.funda$xopr - comp.funda$dp, comp.funda$revt - \n                               comp.funda$xopr - comp.funda$dp)/comp.funda$sale;\n\n# gross profit margin\ncomp.funda$gpm <- coalesce(comp.funda$gp, comp.funda$revt - comp.funda$cogs, \n                           comp.funda$sale - comp.funda$cogs)/comp.funda$sale\n\n# pretax profit margin\ncomp.funda$ptpm <- coalesce(comp.funda$pi, comp.funda$oiadp - comp.funda$xint + \n                              comp.funda$spi + comp.funda$nopi)/comp.funda$sale\n\n# cash flow margin\ncomp.funda$cfm <- coalesce(comp.funda$ibc + comp.funda$dpc, comp.funda$ib + \n                             comp.funda$dp)/comp.funda$sale\n\n# Return on Assets\n#comp.funda$roa <- coalesce(comp.funda$oibdp, comp.funda$sale - comp.funda$xopr,\n#  comp.funda$revt - comp.funda$xopr)/((comp.funda$at+lag(comp.funda$at))/2)\ncomp.funda$roa <- comp.funda$ib/((comp.funda$at+lag(comp.funda$at))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"roa\"] <- NA\n\n# Return on Equity\ncomp.funda$roe <- comp.funda$ib/((comp.funda$be+lag(comp.funda$be))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"roe\"] <- NA\n\n# Return on Capital Employed\ncomp.funda$roce <- coalesce(comp.funda$ebit, comp.funda$sale - \n                              comp.funda$cogs - comp.funda$xsga-comp.funda$dp)/((comp.funda$dltt + \n                                                                                   lag(comp.funda$dltt) + comp.funda$dlc + lag(comp.funda$dlc) + \n                                                                                   comp.funda$ceq + lag(comp.funda$ceq))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"roce\"] <- NA\n\n# effective tax rate\ncomp.funda$efftax <- pmax(0, comp.funda$txt/coalesce(comp.funda$pi, \n                                                     comp.funda$oiadp - comp.funda$xint + comp.funda$spi + comp.funda$nopi))\n\n# after tax return on average common equity\ncomp.funda$aftret_eq <- coalesce(comp.funda$ibcom,comp.funda$ib - \n                                   comp.funda$dvp)/((comp.funda$ceq+lag(comp.funda$ceq))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \n           \"aftret_eq\"] <- NA\n\n# after tax return on invested capital\ncomp.funda$aftret_invcapx <- rowSums(comp.funda[, c(\"ib\", \"xint\", \"mii\")], na.rm = TRUE)/\n  lag((comp.funda$icapt + comp.funda$txditc - comp.funda$mib))\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \n           \"aftret_invcapx\"] <- NA\n\n# after tax return on total stock holder's equity  \ncomp.funda$aftret_equity <- comp.funda$ib/((comp.funda$seq + \n                                              lag(comp.funda$seq))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"aftret_equity\"] <- NA\n\n# pretax return on net operating assets\ncomp.funda$pretret_noa <- coalesce(comp.funda$oiadp, comp.funda$oibdp - \n                                     comp.funda$dp, comp.funda$sale - comp.funda$xopr - comp.funda$dp, \n                                   comp.funda$revt - comp.funda$xopr - comp.funda$dp)/((lag(comp.funda$ppent + \n                                                                                              comp.funda$act - comp.funda$lct) + (comp.funda$ppent + comp.funda$act - \n                                                                                                                                    comp.funda$lct))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"pretret_noa\"] <- NA\n\n# pretax return on total earning assets\ncomp.funda$pretret_earnat <- coalesce(comp.funda$oiadp, comp.funda$oibdp - \n                                        comp.funda$dp, comp.funda$sale - comp.funda$xopr - comp.funda$dp, \n                                      comp.funda$revt - comp.funda$xopr - comp.funda$dp)/((lag(comp.funda$ppent + \n                                                                                                 comp.funda$act) + (comp.funda$ppent + comp.funda$act))/2)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1),\n           \"pretret_earnat\"] <- NA\n\n# gross profitability as % of total assets\ncomp.funda$gprof <- coalesce(comp.funda$gp, comp.funda$revt - comp.funda$cogs, \n                             comp.funda$sale - comp.funda$cogs)/comp.funda$at\n\n## Capitalization ratios\n# Common Equity as % of invested capital\ncomp.funda$equity_invcap <-  comp.funda$ceq/comp.funda$icapt   \n\n# Long-term debt as % of invested capital\ncomp.funda$debt_invcap <-  comp.funda$dltt/comp.funda$icapt    \n\n# Total Debt as % of invested capital\ncomp.funda$totdebt_invcap <- (comp.funda$dltt +  comp.funda$dlc)/comp.funda$icapt  \n\n# capitaliz comp.funda$ation ratio  \ncomp.funda$capital_ratio <-  comp.funda$dltt/(comp.funda$dltt + \n                                                rowSums(comp.funda[, c(\"ceq\", \"pstk_new\")], na.rm = TRUE)) \n\n## Financial Soundness ratios\n# interest as % of average long-term debt\ncomp.funda$int_debt <-  comp.funda$xint/((comp.funda$dltt + lag(comp.funda$dltt))/2) \ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"int_debt\"] <- NA\n\n# interest as % of average total debt\ncomp.funda$int_totdebt <-  comp.funda$xint/((comp.funda$dltt + \n                                               lag(comp.funda$dltt) +  comp.funda$dlc + lag(comp.funda$dlc))/2) \ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"int_totdebt\"] <- NA\n\n# Cash balance to Total Liabilities\ncomp.funda$cash_lt <- comp.funda$che/comp.funda$lt\n\n# inventory as % of current assets\ncomp.funda$invt_act <-  comp.funda$invt/comp.funda$act\n\n# receivables as % of current assets\ncomp.funda$rect_act <-  comp.funda$rect/comp.funda$act\n\n# total debt as % of total assets\ncomp.funda$debt_at <- (comp.funda$dltt +  comp.funda$dlc)/comp.funda$at\n\n# gross debt to ebitda\ncomp.funda$debt_ebitda <- (comp.funda$dltt + comp.funda$dlc)/\n  coalesce(comp.funda$ebitda, comp.funda$oibdp, comp.funda$sale - \n             comp.funda$cogs - comp.funda$xsga)\n\n# short term term as % of total debt\ncomp.funda$short_debt <-  comp.funda$dlc/(comp.funda$dltt +  comp.funda$dlc) \n\n# current liabilities as % of total liabilities\ncomp.funda$curr_debt <-  comp.funda$lct/comp.funda$lt \n\n# long-term debt as % of total liabilities\ncomp.funda$lt_debt <-  comp.funda$dltt/comp.funda$lt\n\n# profit before D&A to current liabilities\ncomp.funda$profit_lct <- coalesce(comp.funda$oibdp, comp.funda$sale - comp.funda$xopr)/comp.funda$lct \n\n# operating cash flow to current liabilities\ncomp.funda$ocf_lct <- comp.funda$ocf/comp.funda$lct\n\n# operating cash flow to total debt\ncomp.funda$cash_debt <- comp.funda$ocf/coalesce(comp.funda$lt, comp.funda$dltt +  comp.funda$dlc)\n\n# Free Cash Flow/Operating Cash Flow\ncomp.funda$fcf_ocf <- pmax(0, (comp.funda$ocf - comp.funda$capx)/comp.funda$ocf)\n\n# total liabilities to total tangible assets\ncomp.funda$lt_ppent <- comp.funda$lt/comp.funda$ppent \ncomp.funda$dltt_be <- comp.funda$dltt/comp.funda$be # long-term debt to book equity\n\n## Solvency ratios\n# Debt-to-assets\ncomp.funda$liabs_assets <- comp.funda$lt/comp.funda$at \n\n# debt-to-capital\ncomp.funda$debt_capital <- (comp.funda$ap + (comp.funda$dlc + \n                                               comp.funda$dltt))/(comp.funda$ap + (comp.funda$dlc + comp.funda$dltt) + \n                                                                    (comp.funda$ceq + comp.funda$pstk_new))\n\n# debt to shareholders' equity ratio\ncomp.funda$de_ratio <- comp.funda$lt/(comp.funda$ceq + comp.funda$pstk_new) \n\n# after tax interest coverage\ncomp.funda$intcov <- (comp.funda$xint +  comp.funda$ib)/comp.funda$xint\n\n# interest coverage ratio\ncomp.funda$intcov_ratio <- coalesce(comp.funda$ebit, comp.funda$oiadp, \n                                    comp.funda$sale - comp.funda$cogs - comp.funda$xsga - comp.funda$dp)/\n  comp.funda$xint\n\n## Liquidity ratios\n# cash ratio\ncomp.funda$cash_ratio <- comp.funda$che/comp.funda$lct\ncomp.funda$cash_ratio <- ifelse(comp.funda$lct > 0, comp.funda$cash_ratio, NA)\n\n# quick ratio (acid test)\ncomp.funda$quick_ratio <- coalesce(comp.funda$act - comp.funda$invt, \n                                   comp.funda$che + comp.funda$rect)/comp.funda$lct \ncomp.funda$quick_ratio <- ifelse(comp.funda$lct > 0, comp.funda$quick_ratio, NA)\n\n# current ratio\ncomp.funda$curr_ratio <- coalesce(comp.funda$act, comp.funda$che + \n                                    comp.funda$rect + comp.funda$invt)/comp.funda$lct \ncomp.funda$curr_ratio <- ifelse(comp.funda$lct > 0, comp.funda$curr_ratio, NA)\n\n# cash conversion cycle\ncomp.funda$cash_conversion <- ((comp.funda$invt + lag(comp.funda$invt))/2)/\n  (comp.funda$cogs/365) + ((comp.funda$rect + lag(comp.funda$rect))/2)/\n  (comp.funda$sale/365) - ((comp.funda$ap + lag(comp.funda$ap))/2)/\n  (comp.funda$cogs/365) \ncomp.funda$cash_conversion <- ifelse(comp.funda$cash_conversion < 0, NA, \n                                     comp.funda$cash_conversion)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"cash_conversion\"] <- NA\n\n## Activity/Efficiency ratios\n# inventory turnover\ncomp.funda$inv_turn <-  comp.funda$cogs/((comp.funda$invt + lag(comp.funda$invt))/2)  \ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"inv_turn\"] <- NA\n\n# asset turnover\ncomp.funda$at_turn <- comp.funda$sale/((comp.funda$at + lag(comp.funda$at))/2)   \ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"at_turn\"] <- NA\n\n# receivables turnover \ncomp.funda$rect_turn <- comp.funda$sale/((comp.funda$rect + lag(comp.funda$rect))/2) \ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"rect_turn\"] <- NA\n\n# payables turnover\ncomp.funda$pay_turn <- (comp.funda$cogs + c(NA, diff(comp.funda$invt)))/((comp.funda$ap + lag(comp.funda$ap))/2) \ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"pay_turn\"] <- NA\n\n# Miscallenous ratios\n#  sale per $ invested capital \ncomp.funda$sale_invcap <- pmax(0, comp.funda$sale/comp.funda$icapt)\n\n#  sales per $ total stockholders' equity\ncomp.funda$sale_equity <-  comp.funda$sale/comp.funda$seq \n\n#  sales per $ working capital  \ncomp.funda$sale_nwc <-  pmax(0, comp.funda$sale/(comp.funda$act - comp.funda$lct))\n\n# R&D as % of  comp.funda$sales\ncomp.funda$xrd <- ifelse(is.na(comp.funda$xrd), 0, comp.funda$xrd)\ncomp.funda$rd_sale <- comp.funda$xrd/comp.funda$sale\n\n# advertising as % of  comp.funda$sales\ncomp.funda$xad <- ifelse(is.na(comp.funda$xad), 0, comp.funda$xad)\ncomp.funda$adv_sale <- comp.funda$xad/comp.funda$sale\n\n# labor expense as % of  comp.funda$sales\ncomp.funda$staff_sale <- pmax(comp.funda$xlr, 0)/comp.funda$sale \n\n## Accruals\ncomp.funda$avg_at <- (comp.funda$at + lag(comp.funda$at))/2 \nx <- -(comp.funda$ch_act - comp.funda$ch_che - comp.funda$ch_lct + comp.funda$ch_dlc + \n         comp.funda$ch_txp - comp.funda$dp)\ncomp.funda$accruals  <-  coalesce(comp.funda$oancf - comp.funda$ib, x)/(comp.funda$avg_at)\ncomp.funda[which(comp.funda$first == 1 | comp.funda$gap != 1), \"accruals\"] <- NA\n\n## Schiller's capei\ncomp.funda$capei <- ((comp.funda$ib + lag(comp.funda$ib, 2) + lag(comp.funda$ib, 3) + lag(comp.funda$ib, 4) + lag(comp.funda$ib, 5))/5)/comp.funda$prcc_f\n\no <- order(comp.funda$gvkey, comp.funda$datadate, comp.funda$fyr)\ncomp.funda <- comp.funda[o, ]\nrm(o)",
    "created" : 1533066550499.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1632607726",
    "id" : "D40DAFB7",
    "lastKnownWriteTime" : 1533066922,
    "last_content_update" : 1533066922137,
    "path" : "C:/Users/Reginald/Dropbox/Research/ceres/code/wrds-compustat-demo.R",
    "project_path" : "code/wrds-compustat-demo.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}